# Cadenza 项目需求文档（PRD v0.1）

## 1. 背景与定位

**Cadenza** 是一款跨平台桌面端钢琴练习软件：连接电子钢琴（MIDI），将曲目（MIDI/MusicXML/PDF 乐谱）转为可练习的“目标轨”，提供类“钢琴英雄”的实时判定、反馈与复盘。默认**应用内出声**（软件音源），支持示范/伴奏的 **autopilot 播放**。

---

## 2. 目标与非目标

### 2.1 产品目标

* **G1 跨平台桌面端**：macOS 优先，其次 Linux，最后 Windows
* **G2 设备兼容**：支持主流 USB MIDI 键盘；后续扩展 BLE MIDI
* **G3 练习闭环**：导入曲目 → 开练 → 实时判定/反馈 → 复盘 → 再练
* **G4 PDF → 可练习谱面**：自动优先，配合最小成本校正，尽量降低人工修正

### 2.2 非目标（阶段性）

* 不做出版级乐谱排版/编辑器（不做 MuseScore/Finale 替代）
* 不承诺 PDF→MIDI “零人工校正”
* 初期不优先 Windows BLE MIDI（USB 先行）

---

## 3. 平台范围与优先级

* **P0：macOS**（首发、核心体验打磨）
* **P1：Linux**（功能对齐、分发打包）
* **P2：Windows**（USB MIDI；BLE 后置）

---

## 4. 目标用户与使用场景

### 4.1 用户画像

* 入门~中级练琴者：需要即时反馈、分段练习、速度渐进
* 有 PDF 谱但无 MIDI：希望快速变成可练习版本
* 技术向用户：可接受工具链配置、偏好可控与可调

### 4.2 核心场景

1. 接键盘 → 选曲 → 跟练 → 实时 Perfect/Good/Miss → 复盘错点 → 循环练
2. 导入 PDF → 自动转换 → 少量修正 → 可练习
3. Autopilot 示范/伴奏播放：只听伴奏或与自己合奏

---

## 5. 术语与关键概念

* **Score（内部谱面模型）**：面向练习/判定的目标事件流（不等同 MusicXML/MIDI）
* **Target Event**：某一时间点期望按下的音符集合（支持单音/和弦/分手）
* **Player Event**：用户输入事件（NoteOn/NoteOff/CC64…）
* **Autopilot**：系统播放事件源（示范/伴奏/节拍器）
* **Monitor（用户监听）**：用户按键触发应用内音源出声（默认开启，可一键关闭）

---

## 6. 功能需求（按模块）

### 6.1 设备与输入（MIDI In）

**Must**

* 设备枚举、连接/断开、热插拔提示
* 接收 NoteOn/NoteOff，保留时间信息（用于判定/回放）
* 连接状态与输入监控页（最近事件、输入强度）

**Should**

* 支持踏板 **CC64**（Damper）：Down/Up（阈值 64）
* 多设备选择（至少允许切换；多输入合并后置）

**Could**

* BLE MIDI（macOS 优先，Windows 后置）
* MIDI Learn（映射控制器到操作）

---

### 6.2 音频与声音引擎（默认应用内出声）

#### 6.2.1 输出与音源

**Must**

* 应用内音频输出（选择输出设备、主音量）
* 内置软件合成器（默认钢琴音色）
* 支持加载外部 SoundFont（SF2）作为可选音源（若 MVP 不做内置高品质库）

**Should**

* Buffer size/延迟策略选项（低延迟/稳定优先）
* 预置音色选择（GM Program 基本映射）

**Could**

* 简易混响/空间感（可选开关）
* 多音色分轨（左右手不同音色等）

#### 6.2.2 监听与双声规避

**Must**

* **监听我的演奏出声：默认开启**（User Monitor Bus）
* **一键关闭监听**（避免与电子琴本体叠音），关闭后仍参与判定/可视化
* Autopilot 出声不受监听开关影响

**Should**

* UI 提示：如双声，关闭监听或建议用户设置 Local Control Off

#### 6.2.3 踏板 CC64 合成行为

**Must**

* Sustain 逻辑（按 source/bus 独立维护状态）：

  * PedalDown：允许 NoteOff 延音
  * PedalUp：释放延音中且未按下的音

---

### 6.3 Autopilot 播放与 Transport

**Must**

* 播放控制：Play/Pause/Stop/Seek（至少支持 Stop/Play）
* Loop（片段循环）
* Tempo 倍率（如 0.5x/0.8x/1.0x）
* 事件调度（lookahead）保证播放稳定不抖

**Should**

* 模式：Demo（全曲）、Accompaniment（分手/分轨播放）
* 节拍器与 Count-in（倒数 1 小节/4 拍等）

**Could**

* 人性化演奏（微弱力度/时值抖动，仅用于 Demo 可选）
* 导出音频（离线渲染）

---

### 6.4 曲目导入与谱面模型

**Must（MVP 建议先从 MIDI 开始）**

* 导入 **MIDI** → 转换为内部 Score（Target Events）
* 基础曲库：最近打开、收藏（可简化为最近列表）
* 片段选择（按时间/小节范围至少一种）

**Should**

* 导入 **MusicXML（子集）**
* 分手轨（Left/Right）在内部模型中可表达

**Could**

* 云曲库/分享（后置）

---

### 6.5 判定与评分（核心体验）

**Must**

* 判定：Perfect/Good/Miss（时间窗口可配置）
* 支持和弦判定（同一目标事件多个音符）
* 统计：错音/漏音/多按
* 练习推进策略（至少一种）：按事件推进（命中后进入下一目标）

**Should**

* 跟随式练习（慢弹也能推进） vs 节拍器式（严格节拍）
* 分手练习：只判定/只播放某一只手
* 延迟校准（offset）与判定对齐

**Could**

* 自适应难度（动态调窗口/速度）
* 更细反馈：早/晚、误差毫秒数、节奏稳定性

> 备注：第一版不要求踏板影响命中判定（踏板主要影响出声与可视化）。

---

### 6.6 反馈与可视化（UI）

**Must**

* 当前目标音符显示（推荐 piano-roll + 键盘高亮）
* 实时判定反馈（命中等级、分数、连击可选）
* 控制：开始/暂停/停止/循环/速度倍率
* 音频设置页：输出设备、主音量、监听开关、各 bus 音量

**Should**

* 复盘：错误热区（时间轴/小节视图至少一种）
* 练习段落管理（循环范围、书签）

**Could**

* 游戏化 UI（评级、成就、排行榜）

---

### 6.7 PDF → 可练习谱面（OMR + 低人工校正）

**Must（第一版保守定义）**

* PDF 导入与逐页渲染
* OMR 引擎接入（可先外部工具链模式）
* 生成 MusicXML/中间格式 → 转 Score
* 失败/低置信度可诊断（告诉用户哪页/哪段不可靠）

**Should**

* 后处理流水线：节拍一致性修正、左右手分配、力度简化、难度估计
* 最小校正工具（非五线谱编辑器）：

  * 删除音符、合并/拆分、左右手切换、时间微调、小节拉伸/压缩

**Could**

* 多 OMR 引擎选择
* 从用户校正中学习（规则/模型迭代）

---

## 7. 非功能需求

### 7.1 性能与实时性

* 输入→反馈稳定；不允许明显卡顿/抖动
* 长曲加载与滚动不崩溃
* 音频线程 realtime-safe：不做阻塞 IO、不做重锁、不频繁分配

### 7.2 可靠性与可诊断

* 设备断开可恢复、异常有明确错误信息
* OMR/转换任务与练习主循环隔离（后台任务失败不影响练习）

### 7.3 可测试性

* 判定逻辑、转换逻辑、踏板行为：单元测试
* Golden tests：固定输入（MIDI/MusicXML/PDF 样例）→ 固定输出（Score 片段）

### 7.4 可维护性与扩展

* 分层清晰：UI / Application / Domain / Infrastructure
* OMR/MIDI/音频引擎均为可替换实现（trait/port）

### 7.5 合规与许可

* 若使用外部 OMR 工具或音源库，需明确分发策略与许可证合规（尤其商用/闭源路径）

---

## 8. MVP 定义与里程碑（建议）

### MVP-1（macOS）：练习闭环 + 应用内出声

* MIDI In（NoteOn/Off + CC64）
* 应用内音源出声（监听默认开，一键关）
* 导入 MIDI → Score → 判定 Perfect/Good/Miss
* Autopilot：基本播放 + loop + 速度倍率
* UI：监控面板 + 基础练习页 + 音频设置页

### MVP-2：MusicXML + 复盘增强

* MusicXML（子集）导入
* 错误统计与复盘视图
* 分段练习、跟随式/节拍器式（至少其一完善）

### MVP-3：PDF→可练习（可用优先）

* PDF 渲染 + OMR 接入 + 转 Score
* 最小校正工具 + 后处理流水线 v1

### MVP-4：Linux 发布

* ALSA MIDI + 打包分发

### MVP-5：Windows（USB MIDI）

* Windows USB MIDI + 打包；BLE 后置

---

## 9. 关键验收标准（摘取）

* **监听开关**：关闭监听后，用户弹奏仍能判定与可视化，但不出声
* **踏板**：CC64 Down/Up 对延音行为正确；PedalUp 能释放延音中音符
* **Autopilot**：播放稳定、loop 不漂移、速度倍率可用
* **判定**：对固定测试用例（含和弦）输出一致且可回归
* **跨平台策略**：macOS 体验优先；Linux 功能对齐；Windows USB 可用

---

## 10. 待确认与开放问题（后续讨论）

1. 内置默认音源策略：内置轻量音色 vs 引导用户选择 SF2（包体/授权）
2. 判定推进策略：严格节拍 vs 跟随式（建议先跟随式更友好）
3. Score 内部时间单位：ms vs beat-tick（影响 tempo change 与回放一致性）
4. OMR 的分发形态：外部工具链/用户自装 vs 内置（许可与体验权衡）
5. 复盘与练习推荐的最小集合：先做热力图还是错误列表？
